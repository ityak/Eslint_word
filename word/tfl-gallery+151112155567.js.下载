var downloaded_in_short_time=!1;TFL.widget("gallery",{defaults:{class_name:"gallery",unique_gallery_array:null,curr_number:0,total_number:0,active_obj:null,before_show:null,after_hide:null,viewer_xpath:"#_widgets_viewer",mask_xpath:"#_widgets_mask",close_xpath:"#_widgets_close",gallery_image_xpath:"#gallery-image",gallery_image_container_xpath:"#gallery-image-container",gallery_iframe_xpath:"#gallery-iframe",gallery_iframe_container_xpath:"#gallery-iframe-container",next_xpath:"#_widgets_viewer a.viewer-next",prev_xpath:"#_widgets_viewer a.viewer-prev",curr_number_xpath:"#_widgets_viewer i#gallery-curr-number",total_number_xpath:"#_widgets_viewer i#gallery-total-number",viewer_info_text_xpath:"#_widgets_viewer .viewer-info-text",download_xpath:"#_widgets_viewer a.viewer-download",pdf_content_xpath:"#pdf-content",file_text_xpath:"#_widgets_viewer span.ui-text",file_download_xpath:"#gallery_file_download",file_save_xpath:"#gallery_file_save",image_download_xpath:"#gallery_image_download",image_save_xpath:"#gallery_image_save",mask_html:'<div style="display: block; top: 0px; left: 0px; position: fixed; width: 100%; height: 100%; background-color: rgb(0, 0, 0); opacity: 0.8;" class="ui-mask" data-no-selection="" id="_widgets_mask"></div>',viewer_html:'<div id="_widgets_viewer" class="viewer" data-no-selection=""><div class="viewer-header"><span hidefocus="true" id="_widgets_close" class="viewer-close font font-del3" data-id="X"></span></div><div class="preview-back"><a href="#" class="pvb-btn" data-id="back" style="display: none;"></a></div><table class="img-viewer" id="gallery-image-container"><tr><td class="viewer-inner"><h3 class="ui-title" data-name="title"><span class="ui-text">Loading file ...</span><span class="ui-btns"><a id="gallery_image_download" hidefocus="true" class="ui-btn font font-download2" data-action="download"></a><a id="gallery_image_save" hidefocus="true" class="ui-btn font font-move" data-action="save"></a></span></h3><img id="gallery-image" class="gallery-image" src="'+TFL.path+'img/gallery-loading.gif" /></td></tr></table><div class="viewer-inner" id="gallery-iframe-container"  style="display:none"><table class="viewer-cnt"><tr><td class="viewer-item" data-name="inner"><div class="other-viewer" data-name="viewer"><div id="pdf-content" class="viewer-content" data-name="box" style=""><div class="viewer-docs" data-name="content"><h3 class="ui-title" data-name="title"><span class="ui-text">Loading file ...</span><span class="ui-btns"><a id="gallery_file_download" hidefocus="true" class="ui-btn font font-download2" data-action="download"></a><a id="gallery_file_save" hidefocus="true" class="ui-btn font font-move" data-action="save"></a></span></h3><iframe id="gallery-iframe" src="#" style="height:100%;"></iframe></div></div></div></td></tr></table></div><div><div class="viewer-info ui-pos" style="margin-bottom: 0px;" data-id="bar"><span class="viewer-info-text" data-id="info"><i id="gallery-curr-number">0</i><i>/</i><i id="gallery-total-number">0</i></span><div class="viewer-info-action ui-pos-right"><a href="#" class="viewer-download" data-id="down"><i></i>下载</a></div></div><a style="" title="Prev" class="viewer-prev" data-id="prev"><span class="font font-preview-arrow-left"></span></a><a style="" title="Next" class="viewer-next" data-id="next"><span class="font font-preview-arrow-right"></span></a></div><div style="display: none;" class="viewer-loading" data-id="loading"></div></div>'},_init:function(){var e=this,a=e.options;e._preload_img(),$(document).delegate("."+a.class_name,"mouseenter",function(){var t=$(this);a.unique_gallery_array=e._get_unique_gallery_array(),a.total_number=a.unique_gallery_array.length,t.attr("gallery-init")||t.bind("click",function(){var t=$(this).attr("href");return a.curr_number=e._get_current_number(t),a.active_obj=a.unique_gallery_array[a.curr_number],e._show_gallery(),!1}).attr("gallery-init",!0)}),$(document).delegate(e.options.gallery_image_xpath+".show-natural","mousedown",function(a){var t=new Date;e.mousedownTime=t.getTime(),e.mousedown=!0,e.mouseup=!1,e.mouseXY={X:a.pageX,Y:a.pageY},a.preventDefault()}),$(document).delegate(e.options.gallery_image_xpath+".show-natural","mouseup",function(a){var t=new Date,i=t.getTime()-e.mousedownTime;200>i?e.noClick=!1:e.noClick=!0,e.mousedown=!1,e.mouseup=!0}),$(document).delegate(e.options.gallery_image_xpath+".show-natural","mousemove",function(a){if(e.mousedown&&!e.mouseup){setTimeout(function(){e.mouseXY.Y=a.pageY,e.mouseXY.X=a.pageX},50);var t=a.pageY-e.mouseXY.Y,i=a.pageX-e.mouseXY.X,n=parseInt($(e.options.gallery_image_xpath).css("margin-top"))+t/2,r=parseInt($(e.options.gallery_image_xpath).css("margin-left"))+i/2,o=$(e.options.gallery_image_xpath).innerWidth()-$(window).innerWidth(),_=$(e.options.gallery_image_xpath).innerHeight()-$(window).innerHeight();console.log(o),n=_>0?n>0?0:n:_>n?_:n,r=o>0?r>0?0:r:o>r?o:r,_>0&&(n=-1*_>n?-1*_:n),o>0?r=-1*o>r?-1*o:r:r>=-1*o&&(r=-1*o),$(e.options.gallery_image_xpath).css({"margin-top":n+"px","margin-left":r+"px"})}}),$(document).delegate(e.options.gallery_image_xpath,"click",function(){if(!e.noClick){var a=new Date;if(!(window.currentClient&&a.getTime()-window.currentClient<100)){window.currentClient=a.getTime();var t=$(e.options.gallery_image_xpath).css("max-width"),i=$(e.options.gallery_image_xpath).css("max-height"),n=$(e.options.gallery_image_xpath)[0].naturalWidth,r=$(e.options.gallery_image_xpath)[0].naturalHeight,o=$(e.options.gallery_image_xpath)[0],_=0===o.src.indexOf("data:image/svg+xml;");if(_){e.isSVG=!0;var l=document.createElement("div");l.innerHTML=decodeURIComponent(o.src);var s=l.querySelector("svg"),d=s.attributes.viewBox.value.split(" ");n=+d[2],r=+d[3],$(e.options.gallery_image_xpath).css("min-width",n),$(e.options.gallery_image_xpath).css("min-height",r)}else e.isSVG=!1;parseInt(i)>r&&parseInt(t)>n||($(e.options.gallery_image_xpath).attr("show-natural")&&"true"==$(e.options.gallery_image_xpath).attr("show-natural")?($(e.options.gallery_image_xpath).attr("show-natural","false"),$(e.options.gallery_image_xpath).css({"max-width":$(e.options.gallery_image_xpath).attr("old-maxWidth"),"max-height":$(e.options.gallery_image_xpath).attr("old-maxHeight"),"margin-top":0,"margin-left":0,"min-width":"unset","min-height":"unset"}),$(e.options.gallery_image_xpath).removeClass("show-natural")):($(e.options.gallery_image_xpath).addClass("show-natural"),$(e.options.gallery_image_xpath).attr("show-natural","true"),$(e.options.gallery_image_xpath).attr("old-maxWidth",t),$(e.options.gallery_image_xpath).attr("old-maxHeight",i),$(e.options.gallery_image_xpath).attr("show-natural","true"),$(e.options.gallery_image_xpath).css({"max-width":n+"px","max-height":r+"px"}),r>$(window).innerHeight()?$(e.options.gallery_image_xpath).css({"margin-top":-1*(r-$(window).innerHeight())/2+"px"}):$(e.options.gallery_image_xpath).css({"margin-top":0}),n>$(window).innerWidth()?$(e.options.gallery_image_xpath).css({"margin-left":-1*(n-$(window).innerWidth())/2+"px"}):$(e.options.gallery_image_xpath).css({"margin-left":0})))}}})},_get_unique_gallery_array:function(){var e=this,a=e.options,t=$("."+a.class_name),i=[];return t.each(function(e,a){var t=$(a).attr("href"),n=$(a).attr("is_related"),r=!1;if("true"!=n){for(var o=0;o<i.length;o++)if(t==i[o].href){r=!0;break}r||i.push({href:$(a).attr("href"),type:$(a).attr("type"),fileName:$(a).attr("file-name"),downloadUrl:$(a).attr("download-url"),id:$(a).attr("id"),cardId:$(a).attr("card_id"),isEnabledDocument:$(a).attr("is_enabled_document"),transferCallback:$(a).attr("transfer-callback"),transferUrl:$(a).attr("transfer-url")})}}),i},_get_current_number:function(e){var a=this,t=a.options,i=0;return $.each(t.unique_gallery_array,function(a,t){e==t.href&&(i=a)}),i},_preload_img:function(){0==$(".gallery-loading").length&&$("body").append('<img style="display:none" class="gallery-loading" src="'+TFL.path+'img/gallery-loading.gif" />')},_show_gallery:function(){var e=this;e.options.before_show&&"function"==typeof e.options.before_show&&e.options.before_show(),e._show_mask(),e._show_viewer()},_hide_gallery:function(){var e=this;e._hide_mask(),e._hide_viewer(),e.options.after_hide&&"function"==typeof e.options.after_hide&&e.options.after_hide()},_show_mask:function(){var e=this,a=e.options;$(a.mask_xpath).length?$(a.mask_xpath).show():$("body").append(a.mask_html)},_hide_mask:function(){var e=this,a=e.options;$(a.mask_xpath).hide()},_init_img_size:function(){var e=this;$(e.options.gallery_image_xpath).css({"margin-top":0,"margin-left":0}),$(e.options.gallery_image_xpath).attr("show-natural","false"),e.noClick=!1},_show_viewer:function(){var e=this,a=e.options;$(a.viewer_xpath).length?$(a.viewer_xpath).show():($("body").append(a.viewer_html),$(a.next_xpath).bind("click",function(){return e._next(),e._init_img_size(),!1}),$(a.prev_xpath).bind("click",function(){return e._prev(),e._init_img_size(),!1}),$(a.download_xpath).bind("click",function(){return e._down(),!1}),$(a.close_xpath).bind("click",function(){return e._hide_gallery(),e._init_img_size(),!1}),$(window).resize(function(){e._fix_iframe_size(),e._fix_image_size(),e._fix_iframe_position()})),e._show_content(),e._reset_prev_next(),$(a.curr_number_xpath).html(a.curr_number),$(a.total_number_xpath).html(a.total_number),$("body").addClass("body-overflow-hidden")},_hide_viewer:function(){var e=this,a=e.options;$(a.gallery_iframe_xpath).attr("src",""),$(a.viewer_xpath).hide(),e._show_loading_image(),$("body").removeClass("body-overflow-hidden")},_show_content:function(){var e=this,a=e.options;e._reset_save_btn(),a.active_obj.type&&"file"==a.active_obj.type?($(a.file_text_xpath).text(a.active_obj.fileName),$(a.file_download_xpath).bind("click",function(){return e._down(),!1}),$(a.file_save_xpath).bind("click",function(){return e._save(),!1}),$(a.gallery_iframe_container_xpath).show(),$(a.gallery_image_container_xpath).hide(),$(a.gallery_iframe_xpath).attr("src",a.active_obj.href),e._fix_iframe_size()):a.active_obj.type&&"video"==a.active_obj.type?($(a.file_text_xpath).text(a.active_obj.fileName),$(a.file_download_xpath).bind("click",function(){return e._down(),!1}),$(a.gallery_iframe_container_xpath).show(),$(a.gallery_image_container_xpath).hide(),$(a.gallery_iframe_xpath).attr("src",a.active_obj.href),e._fix_iframe_size(),$(a.gallery_iframe_xpath).css("background-color","#FFFFFF"),$(".viewer-docs").css("background-color","transparent"),$(".viewer-docs .ui-title").css("background-color","#FFFFFF"),$(a.file_download_xpath).hide(),e._fix_iframe_position()):($(a.file_text_xpath).text(a.active_obj.fileName),$(a.image_download_xpath).bind("click",function(){return e._down(),!1}),$(a.image_save_xpath).bind("click",function(){return e._save(),!1}),$(a.gallery_iframe_container_xpath).hide(),e._fix_iframe_size(),$(a.gallery_image_container_xpath).show(),$(a.gallery_image_xpath).attr("src",a.active_obj.href),e._fix_image_size(),e._reset_css())},_reset_css:function(){$(this.options.file_download_xpath).show(),$(this.options.pdf_content_xpath).css("top","0")},_reset_save_btn:function(){var e=this,a=e.options;a.active_obj.isEnabledDocument?($(a.file_save_xpath).show(),$(a.image_save_xpath).show()):($(a.file_save_xpath).hide(),$(a.image_save_xpath).hide())},_fix_iframe_position:function(){if(this.options.active_obj.type&&"video"==this.options.active_obj.type){var e=($(window).height()-685)/2;$(this.options.pdf_content_xpath).css("top",e>0?e:0)}},_fix_iframe_size:function(){$(this.options.gallery_iframe_xpath).width($(window).width()-100),this.options.active_obj.type&&"video"==this.options.active_obj.type?$(this.options.gallery_iframe_xpath).height(590):$(this.options.gallery_iframe_xpath).height($(this.options.pdf_content_xpath).height()-50)},_fix_image_size:function(){$(this.options.gallery_image_container_xpath).css({height:$(window).height()-50}),$(this.options.gallery_image_xpath).css({"max-width":$(window).width()-100,"max-height":$(this.options.gallery_image_container_xpath).height()-50})},_prev:function(){var e,a=this,t=a.options,i=t.curr_number;i>0&&(a._show_loading_image(),e=t.unique_gallery_array[i-1],$(t.gallery_image_xpath).attr("src",e.href),t.active_obj=e,a._reset_curr_number(),a._reset_prev_next(),a._show_content())},_next:function(){var e,a=this,t=a.options,i=t.curr_number;i+1<t.unique_gallery_array.length&&(a._show_loading_image(),e=t.unique_gallery_array[i+1],$(t.gallery_image_xpath).attr("src",e.href),t.active_obj=e,a._reset_curr_number(),a._reset_prev_next(),a._show_content())},_reset_prev_next:function(){var e=this,a=e.options,t=!0,i=!0;a.curr_number+1<a.unique_gallery_array.length?$(a.next_xpath).addClass("show"):($(a.next_xpath).removeClass("show"),t=!1),a.curr_number>0?$(a.prev_xpath).addClass("show"):($(a.prev_xpath).removeClass("show"),i=!1),0==t&&$(a.viewer_info_text_xpath).hide()},_reset_curr_number:function(){var e=this,a=e.options,t=e._get_current_number(a.active_obj.href);a.curr_number=t,$(a.curr_number_xpath).html(t)},_show_loading_image:function(){var e=this,a=e.options;$(this.options.gallery_image_xpath).attr("src",TFL.path+"img/gallery-loading.gif"),$(a.gallery_iframe_container_xpath).hide(),$(a.gallery_image_container_xpath).show()},_down:function(){function e(e,a){var t=document.createElement("a");t.download=a,t.href=e,document.body.appendChild(t),t.addEventListener("click",function(e){t.parentNode.removeChild(t)}),t.click()}if(!downloaded_in_short_time){downloaded_in_short_time=!0;var a=this,t=a.options,i=t.active_obj.downloadUrl;if(i)if(0===i.indexOf("data:image")){var n;n=0===i.indexOf("data:image/svg")?".svg":i.indexOf("data:image/png")?".png":i.indexOf("data:image/jpg")?".jpg":i.indexOf("data:image/jpeg")?".jpeg":"",e(i,Math.random().toString(36).slice(2)+n)}else window.location.href=i;setTimeout(function(){downloaded_in_short_time=!1},500)}},_save:function(){var e=this,a=e.options,a=(a.active_obj.downloadUrl,_workspace_id?_workspace_id:workspaceId,{title:"转存至文档",url:a.active_obj.transferUrl+"?width=500&height=450&callback="+a.active_obj.transferCallback,dataBtn:"确定:submit_save_file,取消:cancel_save_file",fullscreen:!1,zIndex:1012});TFL.dialog.show(a)}},!0,!0);